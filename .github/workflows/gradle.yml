# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Java CI with Gradle

# on: trigger ì¡°ê±´ì„ ì˜ë¯¸
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ ]

jobs:
  spring-build:

    # Workflow OS ì§€ì •
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    # github workflowëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì½”ë“œ ì ‘ê·¼ì´ ë¶ˆê°€
    # ë”°ë¼ì„œ, github workflowê°€ ëŒì•„ê°€ëŠ” ê³µê°„ì— ê²°ê³¼ë¬¼ì„ í´ë¡ í•˜ì—¬ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë„ë¡ í•˜ìœ„ì˜ ë‹¨ê³„ ì§€ì •
    - name: Checkout
    # ì½”ë“œë¥¼ í´ë¡ í•´ê°€ëŠ” github actionì—ëŠ” ì—¬ëŸ¬ ë²„ì „ì´ ì¡´ì¬í•˜ëŠ”ë°, ê·¸ ì¤‘ 4ë²ˆì§¸ ë²„ì „ì„ ì„ íƒ (ê¸°ë³¸ê°’ì´ì—ˆìŒ)
      uses: actions/checkout@v4

    # JDK ë²„ì „ ì„¤ì • (temurin ì´ë¼ëŠ” ê²ƒì„ í™œìš©)
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Gradle ì„¤ì • ìµœì í™”
    # ì˜ì¡´ì„± ìºì‹œ ë“±ì„ í¬í•¨í•œ ìµœì í™” ê¸°ëŠ¥ ì œê³µ
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0

    # Spring Build
    # NOTE:
    ## Gradle Wrapperë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œí•˜ëŠ” ê²ƒì´ ê¶Œì¥ë˜ì§€ë§Œ,
    ## Gradle Wrapperê°€ ì—†ë‹¤ë©´, ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ë¹Œë“œ!
    # - name: Setup Gradle
    #   uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0
    #   with:
    #     gradle-version: '8.5'
    #
    # - name: Build with Gradle 8.5
    #   run: gradle build
    - name: Build with Gradle Wrapper
      run: |
        ./gradlew build
        echo "ğŸ‰Success: Build Spring ğŸ‰"

    - name: Login Docker-Hub
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        echo  "ğŸ‰Success: Login Docker ğŸ‰"

    - name: Build the Docker Image
      run: | 
        docker build -t ${{ secrets.DOCKER_REPO }} .
        echo  "ğŸ‰Success: Build Docker ğŸ‰"

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_REPO }}
        echo  "ğŸ‰Success: Push Docker Image ğŸ‰"

    - name: SSH to EC2 instance
      uses: appleboy/ssh-action@master
      with:
          host: ${{ secrets.EC2_IP }}
          key: ${{ secrets.EC2_KEY }}
          username: ${{ secrets.EC2_USER_NAME }}
          script: |
              echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_ID }} --password-stdin
              sudo docker pull ${{ secrets.DOCKER_REPO }}
              docker-compose up -d
              echo  "ğŸ‰Success: Docker-Compose Up ğŸ‰"

  # ì˜ì¡´ì„± ê·¸ë˜í”„ ì œì¶œ
  # Why ?
  ## Githubì— ì˜ì¡´ì„± ê·¸ë˜í”„ë¥¼ ì œì¶œí•˜ê²Œ ë˜ë©´, íŒ¨í‚¤ì§€ ê°„ ì˜ì¡´ì„± ê´€ë ¨ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ì—¬ í•„ìš”í•  ë•Œ Githubì—ì„œ ì•Œë ¤ì¤Œ
  ## Ex 1: ì‚¬ìš© ì¤‘ì¸ íŒ¨í‚¤ì§€ì˜ ë²„ì „ ì¶©ëŒ
  ## Ex 2: ì‚¬ìš© ì¤‘ì¸ íŒ¨í‚¤ì§€ì˜ Major ì—…ë°ì´íŠ¸ë¡œ ì¸í•œ ì½”ë“œ ë³€ê²½ -> í˜¸í™˜ì„± ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
  ## Ex 3: íŠ¹ì • ì˜ì¡´ì„±ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ë° ë„ˆë¬´ ë§ì€ ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²½ìš°
  ## Ex 4: ì˜ì¡´ì„± ê´€ë ¨ ë¼ì´ì„ ìŠ¤ ë¬¸ì œ (ìµœê·¼ Redis ë¼ì´ì„ ìŠ¤ê°€ ë³€ê²½ë˜ì–´ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ëª»í•˜ê²Œ ëœ ê²ƒì²˜ëŸ¼)
  dependency-submission:

    runs-on: ubuntu-latest
    # ì˜ì¡´ì„± ê·¸ë˜í”„ ì œì¶œì„ ìœ„í•´ì„ , git workflowì—ì„œ ì“°ê¸° ì‘ì—… í—ˆìš©ì´ í•„ìš”í•¨
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Generates and submits a dependency graph, enabling Dependabot Alerts for all project dependencies.
    # See: https://github.com/gradle/actions/blob/main/dependency-submission/README.md
    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0
